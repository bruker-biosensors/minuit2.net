name: Build ROOT::Minuit2 C# Wrapper
run-name: ${{ github.actor }} is creating a new wrapper ðŸš€

on:
  push:
    tags: ["v*.*.*"]
    branches: ['**']

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      sem-ver: ${{ steps.determine-version.outputs.GitVersion_SemVer }}
      assembly-sem-ver: ${{ steps.determine-version.outputs.GitVersion_AssemblySemVer }}
      assembly-sem-file-ver: ${{ steps.determine-version.outputs.GitVersion_AssemblySemFileVer }}
      assembly-informational-version: ${{ steps.determine-version.outputs.GitVersion_InformationalVersion }}
      pre-release-label: ${{ steps.determine-version.outputs.PreReleaseLabel }}
    steps:
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v3.1.1
        with:
          versionSpec: '6.0.x'
          preferLatestVersion: true

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: determine-version
        uses: gittools/actions/gitversion/execute@v3.1.1
        with:
          useConfigFile: true

  build:
    name: Build Project
    needs: determine-version
    runs-on: windows-latest
    strategy: 
      matrix:
        build:
          - {
              "use-openmp": "ON",
              "assembly-name": "minuit2.net.openmp",
              "package-id": "minuit2.net.openmp"
          }
          - {
              "use-openmp": "OFF",
              "assembly-name": "minuit2.net",
              "package-id": "minuit2.net"
          }
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install .NET SDK
        uses: actions/setup-dotnet@v4

      - name: Build x86 library
        run: dotnet build ./minuit2.net/ --configuration Release -p:Platform=x86 -p:UseOpenMP=${{ matrix.build.use-openmp }}

      - name: Build x64 library
        run: dotnet build ./minuit2.net/ --configuration Release -p:Platform=x64 -p:UseOpenMP=${{ matrix.build.use-openmp }}

      - name: Build ARM64 library
        run: dotnet build ./minuit2.net/ --configuration Release -p:Platform=ARM64 -p:UseOpenMP=${{ matrix.build.use-openmp }}

      - name: Test
        run: dotnet test ./minuit2.net/ --configuration Release  -p:UseOpenMP=${{ matrix.build.use-openmp }}

      - name: Build NuGet Package
        shell: pwsh
        # Overview of the different versions: https://gist.github.com/jonlabelle/34993ee032c26420a0943b1c9d106cdc
        run: |
          dotnet pack `
            -p:Version=${{ needs.determine-version.outputs.sem-ver }} `
            -p:FileVersion=${{ needs.determine-version.outputs.assembly-sem-file-ver }} `
            -p:AssemblyName=${{ matrix.build.assembly-name }} `
            -p:AssemblyVersion=${{ needs.determine-version.outputs.assembly-sem-ver }} `
            -p:AssemblyInformationalVersion=${{ needs.determine-version.outputs.assembly-informational-version }} `
            -p:PackageId=${{ matrix.build.package-id }} `
            -p:UseOpenMP=${{ matrix.build.use-openmp }} `
            --no-build `
            --configuration Release `
            --output ./bin `
            --warnaserror `
            --nologo `
            ./minuit2.net/minuit2.net.csproj

      - name: Install dotnet-validate
        run: dotnet tool install --global dotnet-validate --version 0.0.1-preview.537

      - name: Validate NuGet package
        run: dotnet-validate package local **/bin/minuit2.net.*.nupkg

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build.package-id }}
          path: ./bin/
          if-no-files-found: error
          
  publish:
    name: Publish Packages
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-id: ["minuit2.net", "minuit2.net.openmp"]
    if: github.ref_type == 'tag'
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.package-id }}
          path: ./bin/

      - name: Publish NuGet Package
        run: |
          dotnet nuget push "**/bin/minuit2.net.*.nupkg" --api-key ${{ secrets.PUBLISH_PACKAGE_TOKEN }} --source "https://api.nuget.org/v3/index.json"

  release:
    name: Release Packages
    needs: publish
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      packages: write
      contents: write
    steps:
      - name: Create a Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ steps.determine-version.outputs.sem-ver }}"
          prerelease: ${{ needs.determine-version.outputs.pre-release-label != '' }}
